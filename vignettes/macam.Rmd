---
title: "macam: A collection of miscellaneous functions for ecology in R"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{macam: A collection of miscellaneous functions for ecology in R}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Installation
```{r, message=FALSE, eval=FALSE}
#install.packages("remotes")
#remotes::install_github("ong8181/macam")
remotes::install_github("ong8181/macam", build_vignettes = TRUE, force = TRUE)
```

# Load library
```{r, eval=FALSE}
library(macam)
packageVersion("macam")
browseVignettes("macam")
```

# Quick tutrials
## File/directory handling
- `outdir_create()`
```{r, eval=FALSE}
# Create output directory and save the directory name
output_dir <- outdir_create()
# Change str_end if the file extension is not ".R"
#output_dir <- outdir_create(str_end = 5)
```

- `save_workspace()`
```{r, eval=FALSE}
# Save workspace in the output directory
save_workspace(output_dir)
```

- `save_session_info()`
```{r, eval=FALSE}
# Save session information in 00_SessionInfo directory
save_session_info(create_session_info_dir = TRUE)
```

## Sequence analysis
- `AllOrients()`
```{r, eval=FALSE}
AllOrients("ATGC")
```

- `PrimerHits()`
see [DADA2 tutrial](https://benjjneb.github.io/dada2/ITS_workflow.html).

- `rarefy_even_coverage()`, `plot_rarefy()`
```{r, eval = FALSE}
# Load library
library(tidyverse)
library(phyloseq)
library(ShortRead)

# Load demo data
data(sample_sheet, asv_sheet, tax_sheet)
# Check colnames and rownames
dim(sample_sheet); dim(asv_sheet); dim(tax_sheet)
all(rownames(asv_sheet) == rownames(sample_sheet))
all(colnames(asv_sheet) == rownames(tax_sheet))

# ----------------------------------------------- #
# Import to phyloseq and data handling
# ----------------------------------------------- #
# Import to phyloseq
ps_all <- phyloseq(otu_table(asv_sheet, taxa_are_rows = FALSE),
                   sample_data(sample_sheet),
                   tax_table(as.matrix(tax_sheet)))
ps_sample <- ps_all %>%
  subset_samples(sample_nc == "sample" & Site == "sea") %>%
  prune_taxa(taxa_sums(.) > 0, .)
sample_sums(ps_sample)

# ----------------------------------------------- #
# Perform coverage-based rarefaction
# ----------------------------------------------- #
set.seed(1234)
ps_rare_raw <- rarefy_even_coverage(ps_sample,
                                    coverage = 0.97,
                                    knots = 100,
                                    rarefy_average_method = "round", # Specify how iterated rarefaction results are averaged. You may change.
                                    include_iNEXT_results = TRUE)
ps_rare <- ps_rare_raw[[1]] # Extract phyloseq object
sample_sums(ps_rare)
sample_data(ps_rare)

# ----------------------------------------------- #
# Visualize rarefaction curve
# ----------------------------------------------- #
plot_rarefy(ps_rare_raw) +
  coord_cartesian(xlim = c(0, 4000))
```

- `taxa_name_summarize()`
To be added.

## Time series analysis
- `s_map_rgl()`
```{r}
# Load library
library(rEDM)
packageVersion("rEDM") # v0.7.5

# Load data
data(data_2sp)

# Normalize and check model time series
x1 <- as.numeric(scale(data_2sp$x[101:1000])) # Discard the first 100 data

# Estimate best embeding dimension
simp_res1 <- rEDM::simplex(x1, E = 1:20, silent = T)
(Ex1 <- simp_res1[which.min(simp_res1$rmse), "E"])
block_x1 <- rEDM::make_block(x1, max_lag = Ex1)[,2:(Ex1+1)]

# Perform S-map
x1_smap <- s_map_regl(block_x1, theta = 1, lambda = 0.1,
                      regularized = F, random_seed = 1234)
x1_ridge <- s_map_regl(block_x1, theta = 1, lambda = 0.1,
                       regularized = T, alpha = 0, random_seed = 1234)
x1_lasso <- s_map_regl(block_x1, theta = 1, lambda = 0.1,
                       regularized = T, alpha = 1, random_seed = 1234)

```

- `twin_surrogate_cpp()`

## ggplot2 functions
- `label_to_power10()`
